{
  "contents": [
    {
      "role": "user",
      "parts": [
        {
          "text": "You are a senior Flutter + Firebase + Android engineer. I have a Flutter app (Exam Ready) where the user logs in. When I run the app on a real Android phone, if I close the app (swipe it away from recents or let the system kill it) and then reopen it, the app starts from the entry/login screen again and the user has to log in every time.\n\nI want you to read my entire Flutter project and:\n1) Find exactly how authentication and session handling are currently implemented.\n2) Fix the app so that the **login session is persisted** correctly on Android. The user must stay logged in until they explicitly log out.\n3) Make the root navigation logic robust so that:\n   - If the user is already authenticated, the app should open directly to the main/home/dashboard screen.\n   - If the user is not authenticated, the app should show the login/entry screen.\n   - This should work correctly even after the Android OS kills the app or the user swipes it away and then reopens it.\n\n---\n\nPROJECT CONTEXT\n\n• The app is written in Flutter (Dart).\n• It uses Firebase (FirebaseAuth + Firestore) and Riverpod (or similar state management) in other parts of the app.\n• There is an entry/login screen and a dashboard/home screen.\n• I am seeing behaviour where, after closing the app and reopening it, it does **not** remember the session correctly and always shows the login screen again.\n\n---\n\nYOUR TASKS (DETAILED)\n\n1) **Detect current auth/session flow**\n   - Scan the project for:\n     - Where FirebaseAuth (or any auth service) is initialized and used.\n     - The login function (email/password, Google, phone, whatever is used).\n     - How the app decides which screen to show first (main.dart, root widget, splash screen, etc.).\n     - Any use of providers (Riverpod, Provider, GetX, etc.) that store user state.\n     - Any code that calls signOut(), clears providers, or resets state.\n\n2) **Implement proper persistent login**\n   - Use FirebaseAuth (or the existing auth backend) to persist user state.\n   - On app startup, do NOT force the user to log in again if there is already a valid authenticated user.\n   - Use one of these patterns (you choose the cleanest for my project):\n     a) A Splash/Root widget that listens to FirebaseAuth.instance.authStateChanges() and navigates to Login or Home accordingly.\n     b) A Riverpod StreamProvider or StateNotifier that exposes the current auth state, and a top-level widget that reacts to that auth state.\n   - Make sure this works robustly even when the app process is completely restarted.\n\n3) **Avoid accidental logouts on app close**\n   - Verify that I am not calling signOut() in dispose() methods, on lifecycle changes, or when the navigation stack changes.\n   - If any such code exists (e.g., signOut() in a screen's dispose, or in an observer when the app moves to background), remove or refactor it.\n   - Ensure that logging out only happens when the user explicitly taps a Logout button.\n\n4) **Handle Android-specific behaviour**\n   - Keep in mind that on Android, when the app is closed, the process is destroyed; static variables and in-memory providers are reset.\n   - Therefore, rely on:\n     - FirebaseAuth's built-in persistence (currentUser, authStateChanges()).\n     - Optionally SharedPreferences / Hive / secure storage for extra lightweight flags (like user role, onboarding completion), but NOT for manual token management if Firebase is already in use.\n   - Show me the correct way to combine this with Riverpod, so that state is reconstructed on startup from FirebaseAuth and optional local storage.\n\n5) **Update main.dart / root widget**\n   - Refactor main.dart (or the root widget) to have a clean, single source of truth for:\n     - Whether the user is logged in.\n     - Which initial route/screen to show.\n   - Prefer a pattern like:\n     - A top-level widget that uses a StreamBuilder or Riverpod StreamProvider around FirebaseAuth.instance.authStateChanges().\n     - When user != null: show Home/DashboardScreen.\n     - When user == null: show LoginScreen.\n   - Ensure navigation is done with Navigator or GoRouter in a consistent way (you can keep my existing routing style but make it clean).\n\n6) **Show code changes clearly**\n   - Provide updated, full code for any files you modify (not only tiny diffs), especially:\n     - lib/main.dart\n     - Any auth-related service (e.g., lib/services/auth_service.dart)\n     - Any splash/root widget (if you add one)\n     - Any login screen file where you change login logic\n     - Any logout button handler\n   - Explain briefly why each change fixes the issue of the session ending on app close.\n\n7) **Session behaviour requirements**\n   - After successful login, if the user closes the app and reopens it, they should see the main app (not the login screen) as long as FirebaseAuth still has a valid currentUser.\n   - Only when the user explicitly logs out should they see the login screen again.\n   - Do not implement custom token storage unless absolutely necessary; rely on FirebaseAuth persistence.\n\n8) **Optional improvements** (if simple to add):\n   - Add a very light Splash screen that shows a logo while auth state is being checked.\n   - Add minimal error handling (e.g., if Firebase fails to initialize, show a simple retry or error message).\n\n---\n\nINPUT FILES / IMPORTANT PATHS (YOU SHOULD OPEN & MODIFY AS NEEDED)\n\n- lib/main.dart\n- Any auth-related service files (e.g., lib/services/auth_service.dart)\n- Login / entry screen files (e.g., lib/screens/ui/login.dart or similar)\n- Home / dashboard screen files (e.g., lib/screens/ui/dashboard_screen.dart)\n- Any root navigation / splash / wrapper widgets.\n\n---\n\nOUTPUT EXPECTATION\n\n- A clear explanation of the root cause of the session loss on Android.\n- A clean, robust solution using FirebaseAuth persistence and/or local storage.\n- Full, updated source code for each modified file.\n- A short checklist I can follow to verify that:\n  - 1) Login works,\n  - 2) Closing and reopening the app keeps the session,\n  - 3) Explicit Logout works and returns to the login screen.\n"
        }
      ]
    }
  ]
}
